## DaJet Script

[Начало](https://github.com/zhichkin/dajet/tree/main/doc/dajet-script/README.md)

### Тип ```entity```

- [Общие сведения](#общие-сведения)
- [Функции для работы с типом ```entity```](#функции-для-работы-с-типом-entity)
- [Типизированное объявление ```entity```](#типизированное-объявление-entity)

#### Общие сведения

Ссылочные типы данных 1С:Предприятие 8 - это сущности, которые идентифицируются своим уникальным ключом (ссылкой), а не значениями своих свойств. При помощи такого ключа можно ссылаться на отдельно взятые сущности в свойствах других объектов. На уровне реляционной базы данных ссылки играют роль первичных и внешних ключей. Например, ссылочными типами данных являются справочники и документы 1С:Предприятие 8.

Тип данных ```entity``` - это ссылка. Внутренняя реализация ```entity``` представляет собой структуру, которая состоит из двух полей: целочисленный код типа ссылки (integer) и уникальный идентификатор (UUID). Данная структура является указателем (ссылкой) на конкретный объект в базе данных или его отсутствие - "пустая ссылка".

Интересно отметить, что с точки зрения, например ORM (object-relational mapping), код типа ссылки играет роль дискриминатора типа и используется на уровне прикладного кода и таблиц базы данных соответствующим образом.

> "Пустая ссылка" всегда строго типизированна, то есть указывает на отсутствие объекта какого-то определённого типа, например, "Справочник.Номенклатура".

> Специальным значением ```entity``` является "нулевая ссылка" (значение по умолчанию). Это ссылка, которая ни на что не указывает, так как ей пока что не присвоено конкретное значение.

**Структура хранения ссылок на уровне СУБД**
|**Поле СУБД**|**MS SQL Server**|**PostgreSQL**|**C#**|**DaJet Script**|**Примечание**|
|---|---|---|---|---|---|
|_TRef|binary(4)|bytea|int|number|Код типа ссылки<br>`В определённых случаях может отсутствовать для оптимизации (уменьшения) объёма хранимых данных`|
|_RRef|binary(16)|bytea|Guid|uuid|Значение ссылки<br>`Обязательное поле`|

**Представление различных видов ссылок ```entity```**
```
Нулевая    ссылка:  {0:00000000-0000-0000-0000-000000000000}
Пустая     ссылка: {36:00000000-0000-0000-0000-000000000000}
Конкретная ссылка: {36:08ec109d-a06b-a1b1-11ee-ca472bff0a0d}
```

Целочисленный код типа ссылки определяется и фиксируется в момент создания нового класса сущности в информационной базе 1С:Предприятие 8. В терминах 1С это называется "объект метаданных". Например, объект метаданных справочника "Номенклатура" может иметь код ```12``` в одной информационной базе 1С:Предприятие 8, однако, в другой информационной базе одноимённый и аналогичный по содержанию справочник может иметь другое значение кода своего типа, например, ```21```.

`Другими словами, код типа объекта метаданных зависит от контекста базы данных, в которой он был создан.`

> Важно отметить, что код типа метаданного используется для формирования имён прикладных таблиц базы данных, где хранятся пользовательские данные приложения 1С:Предприятие 8. Например, если код справочника "Номенклатура" имеет значение ```36```, то имя его таблицы будет равно ```_Reference36```.

Кроме этого, на уровне хранилища метаданных 1С:Предприятие 8 существует внутренний уникальный идентификатор типа объекта метаданных в виде UUID. Этот идентификатор также генерируется в момент создания нового объекта метаданных. Однако, он имеет исключительно служебное значение и не используется для хранения в прикладных таблицах приложения 1С:Предприятие 8.

> Таким образом, в целях синхронизации данных приложений идентичных или аналогичных объектов метаданных между различными информационными базами 1С:Предприятие 8 используются их строковые представления или "полное имя объекта метаданных", например, "Справочник.Номенклатура".

Уникальный идентификатор ссылки генерируется платформой 1С:Предприятие 8 или присваивается разработчиком прикладного решения в момент создания новой сущности определённого типа и её записи в базу данных. Эта возможность часто используется для синхронизации сущностей "по ссылке" при обменах данными между различными прикладными решениями. Например, типовые решения 1С:Предприятие 8 для этих целей используют таблицы соответствия идентификаторов объектов между собой (регистр сведений "СоответствияОбъектовИнформационныхБаз").

Значение типа ```entity``` можно получить из базы данных 1С:Предприятие 8 при помощи следующего кода DaJet Script:

```TSQL
DECLARE @Ссылка entity

USE 'mssql://server/database'
   SELECT TOP 1 Ссылка INTO @Ссылка
     FROM Справочник.Номенклатура
    WHERE Код = 'ABCD-1234'
END

PRINT @Ссылка

-- Результат выполнения скрипта
[2024-10-01 14:31:59] {36:08ec109d-a06b-a1b1-11ee-ca472bff0a0d}
```

Далее можно использовать полученную ссылку в запросах для фильтрации данных, например, следующим образом:

```TSQL
DECLARE @array  array
DECLARE @object object
DECLARE @Ссылка entity

USE 'mssql://server/database'

   -- Получаем ссылку на нужный товар
   SET @Ссылка = SELECT TOP 1 Ссылка
                   FROM Справочник.Номенклатура
                  WHERE Код = 'ABCD-1234'

   -- Выбираем дату, номер и сумму тех документов,
   -- в которых клиенты заказывали нужный товар
   SELECT DISTINCT
          Дата  = Документ.Дата
        , Номер = Документ.Номер
        , Сумма = Документ.СуммаДокумента
     INTO @array
     FROM Документ.ЗаказКлиента.Товары AS Товары
    INNER JOIN Документ.ЗаказКлиента   AS Документ
       ON Документ.Ссылка = Товары.Ссылка
    WHERE Товары.Номенклатура = @Ссылка

END

-- Выводим результат в лог программы
FOR @object IN @array
   PRINT JSON(@object)
END

-- Результат выполнения скрипта
[2024-10-03 13:14:35] {"Дата":"2023-01-01T00:00:00","Номер":"00000001","Сумма":123.00}
[2024-10-03 13:14:35] {"Дата":"2023-06-24T02:07:24","Номер":"00000003","Сумма":333.00}
```

[Наверх](https://github.com/zhichkin/dajet/tree/main/doc/dajet-script/entity/README.md#тип-entity)

#### Функции для работы с типом ```entity```

Для удобства работы с типом ```entity``` в DaJet Script реализован набор встроенных функций. Эти функции позволяют создавать новые ссылки из простых типов ```number``` и ```uuid```, получать значения полей структуры ```entity``` и так далее. Некоторые функции имеют перегруженные версии, то есть отличаются набором параметров. Кроме этого функции отличаются между собой требованием наличия контеста СУБД, то есть вызовом "внутри" команды **USE**, а также возможностью использования в запросах СУБД или выражениях DaJet Script.

**Таблица функций типа ```entity```**
|**Функция**|**Возврат**|**Параметры**|**Описание**|**Команда USE**|**Запрос СУБД**|**Выражение<br>DaJet Script**|
|---|---|---|---|---|---|---|
|ENTITY|entity|string|Создаёт пустую ссылку по полному имени объекта метаданных|да|нет|да|
|ENTITY|entity|string<br>uuid|Создаёт конкретную ссылку по полному имени объекта метаданных и идентификатору<br>`Наличие объекта в базе данных, имеющего такую ссылку, не гарантировано`|да|нет|да|
|ENTITY|entity|number<br>uuid|Создаёт конкретную ссылку или пустую ссылку по коду типа объекта метаданных и идентификатору|нет|нет|да|

[Наверх](https://github.com/zhichkin/dajet/tree/main/doc/dajet-script/entity/README.md#тип-entity)

#### Типизированное объявление ```entity```

Существует ещё один способ объявить перемнную типа ```entity```. Этот способ позволяет указать тип ссылки при помощи строкового представления объекта метаданных 1С:Предприятие 8. Такое объявление делает код более наглядным. Важно отметить, что нижеследующий код будет работать корректно только "внутри" блока команды **USE**, так как разрешение имён метаданных и их кодов зависит от контекста соответствующей информационной базы 1С:Предприятие 8.

```TSQL
USE 'mssql://server/database'
   DECLARE @Ссылка Справочник.Номенклатура
   PRINT @Ссылка
END

-- Результат выполнения скрипта
[2024-10-01 14:46:58] {36:00000000-0000-0000-0000-000000000000}
```
[Наверх](https://github.com/zhichkin/dajet/tree/main/doc/dajet-script/entity/README.md#тип-entity)
