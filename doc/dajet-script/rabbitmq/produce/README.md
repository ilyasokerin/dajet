## DaJet Script

[RabbitMQ](https://github.com/zhichkin/dajet/tree/main/doc/dajet-script/rabbitmq/README.md)

### Команда PRODUCE

- [Регистр сведений исходящих сообщений](#регистр-сведений-исходящих-сообщений)
- [Базовый пример публикации сообщений](#базовый-пример-публикации-сообщений)
- [Пользовательские заголовки сообщений](#пользовательские-заголовки-сообщений)

```SQL
PRODUCE 'amqp://<username>:<password>@<server>:<port>/<virtual-host>'
 SELECT <options>
```
**\<username\>** - имя пользователя<br>
**\<password\>** - пароль пользователя<br>
**\<server\>** - адрес сервера RabbitMQ<br>
**\<port\>** - порт сервера RabbitMQ<br>
**\<virtual-host\>** - виртуальный хост сервера RabbitMQ<br>
**\<options\>** - свойства сообщения RabbitMQ (смотри ниже)

> Строка подключения к брокеру RabbitMQ указывается в формате URL, следовательно, все специфические символы, например в пароле пользователя, должны быть указаны в URL-кодировке.

**Таблица свойств публикуемого сообщения RabbitMQ**

|**Свойство**|**Тип данных**|**Описание**|
|---|---|---|
|AppId|string|Наименование отправителя|
|Exchange|string|Наименование топика для публикации сообщения|
|RoutingKey|string|Ключ маршрутизации, если свойство Exchange заполнено.<br>В противном случае - наименование очереди для прямой отправки без маршрутизации.|
|Mandatory|number|Признак обязательности наличия очереди назначения. Подробнее смотри документацию RabbitMQ.<br>По умолчанию DaJet Script не использует этот флаг.|
|MessageId|string|Идентификатор сообщения|
|Type|string|Тип сообщения|
|Body|string|Тело сообщения: DaJet Script ориентируется на текстовые сообщения в кодировке **UTF-8**.|
|BlindCopy|string<br>(csv)|Дополнительные ключи маршрутизации, разделённые запятой. Значения ключей не доставляются получателю.|
|CarbonCopy|string<br>(csv)|Дополнительные ключи маршрутизации, разделённые запятой. Значения ключей доставляются получателю. Использовать не рекомендуется (оптимизация трафика).|
|ContentType|string|Тип содержимого тела сообщения.<br>Значение по умолчанию: **application/json**|
|ContentEncoding|string|Формат (кодировка) тела сообщения.<br>Значение по умолчанию: **UTF-8**|
|DeliveryMode|number|Вид доставки: 1 - in-memory, 2 - persistent.<br>Значение по умолчанию: 2 (сохранение на диск)|
|Priority|number|Приоритет доставки сообщения от 0 до 9<br>Значение по умолчанию: 0 (ноль)|
|ReplyTo|string|Адресат для обратной связи, определяемый логикой приложения.|
|CorrelationId|string|Идентификатор корреляции сообщений между собой, определяемый логикой приложения.|
|Expiration|string|Спецификация устаревания сообщения. Подробнее смотри документацию RabbitMQ. По умолчанию не используется.|
|Headers|object|Пользовательские заголовки (смотри документацию ниже)|

[Наверх](#команда-produce)

#### Регистр сведений исходящих сообщений



[Наверх](#команда-produce)

#### Базовый пример публикации сообщений

```SQL
DECLARE @message object

USE 'mssql://zhichkin/dajet-exchange'

   CONSUME TOP 1000
           НомерСообщения
         , ТипСообщения
         , ТелоСообщения
         , Получатель
      INTO @message
      FROM РегистрСведений.ИсходящиеСообщения
     ORDER BY НомерСообщения ASC
    
   PRODUCE 'amqp://guest:guest@localhost:5672/dajet'
    SELECT AppId         = 'Центральный офис'
         , Exchange      = 'test-exchange'
         , RoutingKey    = @message.Получатель
         , MessageId     = @message.НомерСообщения
         , ТипСообщения  = @message.ТипСообщения
         , ТелоСообщения = @message.ТелоСообщения

END
```

[Наверх](#команда-produce)

#### Пользовательские заголовки сообщений

[Наверх](#команда-produce)
