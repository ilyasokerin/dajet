## DaJet Script

[Начало](https://github.com/zhichkin/dajet/tree/main/doc/dajet-script/README.md)

### Управление последовательностью

Управление последовательностью решает задачу согласованности данных в процессе регистрации их изменений и последующей доставки, обмена данными, между узлами интеграции по принципу FIFO. Механизм управления последовательностью основан на понятии "векторных часов". На уровне баз данных этот механизм реализован при помощи полей типа IDENTITY и специальных объектов ядра СУБД - генераторов последовательностей (SEQUENCE). Платформа 1С:Предприятие 8 не имеет адекватных средств для решения этой задачи. Особенно это касается высоко нагруженных и конкурентных условий эксплуатации.

Для управления последовательностью DaJet Script реализует набор команд и функций, которые позволяют работать с объектами SEQUENCE ядра СУБД: создавать и удалять, применять и отзывать для соответствующих объектов 1С:Предприятие 8, а также получать следующее значение последовательности в запросах.

> Квадратные скобки в описании синтаксиса команд означают необязательные опции.

- [Функция VECTOR](#функция-vector)
- [CREATE SEQUENCE](#create-sequence)
- [DROP SEQUENCE](#drop-sequence)
- [APPLY SEQUENCE](#apply-sequence)
- [REVOKE SEQUENCE](#revoke-sequence)
- [Дополнительные материалы](#дополнительные-материалы)

#### Функция VECTOR

Функция **VECTOR** возвращает следующее значение счётчика именованной последовательности. Гарантированно, что одно и тоже значение счётчика не может быть получено при повторном вызове этой функции, а также при одновременном вызове параллельно в разных потоках выполнения. Функция **VECTOR** всегда выполняется в контексте соответствующей базы данных, то есть требует использования "внутри" команды **USE**. Вызов функции имеет следующий синтаксис:
```TSQL
VECTOR('<sequence_name>')
```
**\<sequence_name\>** - имя объекта последовательности СУБД. Имя заключено в одинарные кавычки - это строковое значение.

**1. Пример использования функции VECTOR:**
```TSQL
DECLARE @next    number
DECLARE @current number

SET @current = SELECT VECTOR('my_sequence')
SET @next = @current + 1

PRINT 'Значения my_sequence:'
PRINT '- текущее   = ' + @current
PRINT '- следующее = ' + @next

-- Результат выполнения скрипта

```


**2. Указание несуществующей последовательности при вызове функции **VECTOR** генерирует ошибку:**
```TSQL
SELECT VECTOR('non_existent')
```

[Наверх](#управление-последовательностью)

#### CREATE SEQUENCE

Команда для создания именованного объекта последовательности базы данных в случае его отсутствия. Имеет следующий синтаксис:
```TSQL
CREATE SEQUENCE <identifier> [AS <type>] [START WITH <start>] [INCREMENT BY <step>] [CACHE <size>]
```
**\<identifier\>** - имя объекта последовательности.<br>
**\<type\>** - тип данных счётчика последовательности. По умолчанию на уровне СУБД используется тип ```bigint```.<br>
**\<start\>** - начальное значение счётчика последовательности, целочисленная константа. По умолчанию равно ```1```.
**\<step\>** - шаг приращения счётчика последовательности, целочисленная константа. По умолчанию равно ```1```.
**\<size\>** - количество значений счётчика последовательности, выделяемых ядром СУБД заранее для увеличения производительности. По умолчанию равно ```1```.

**Пример создания последовательности ```so_outgoing_queue```**
```TSQL
DECLARE @current number

USE 'mssql://server/database'

   CREATE SEQUENCE so_outgoing_queue

   SET @current = SELECT VECTOR('so_outgoing_queue')

END

PRINT 'Текущее значение счётчика последовательности'
PRINT 'so_outgoing_queue = ' + @sequence

-- Результат выполнения скрипта

```

[Наверх](#управление-последовательностью)

#### DROP SEQUENCE

[Наверх](#управление-последовательностью)

#### APPLY SEQUENCE

[Наверх](#управление-последовательностью)

#### REVOKE SEQUENCE

[Наверх](#управление-последовательностью)
