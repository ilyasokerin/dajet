## DaJet Script

[Начало](https://github.com/zhichkin/dajet/tree/main/doc/dajet-script/README.md)

### Управление последовательностью

Управление последовательностью решает задачу согласованности данных в процессе регистрации их изменений и последующей доставки, обмена данными, между узлами интеграции по принципу FIFO. Механизм управления последовательностью основан на понятии "векторных часов". На уровне баз данных этот механизм может быть реализован при помощи специальных объектов ядра СУБД - генераторов последовательностей (SEQUENCE). Платформа 1С:Предприятие 8 не имеет адекватных средств для решения этой задачи. Особенно это касается высоко нагруженных и конкурентных условий эксплуатации.

Для управления последовательностью DaJet Script реализует набор команд и функций, которые позволяют работать с объектами SEQUENCE ядра СУБД: создавать и удалять, применять и отзывать для соответствующих объектов 1С:Предприятие 8, а также получать следующее значение последовательности в запросах.

> На уровне СУБД счётчик последовательности имеет тип данных ```bigint```.

- [Функция VECTOR](#функция-vector)
- [CREATE SEQUENCE](#create-sequence)
- [DROP SEQUENCE](#drop-sequence)
- [APPLY SEQUENCE](#apply-sequence)
- [REVOKE SEQUENCE](#revoke-sequence)
- [Дополнительные материалы](#дополнительные-материалы)

#### Функция VECTOR

Функция **VECTOR** возвращает следующее значение счётчика именованной последовательности. Гарантированно, что одно и тоже значение счётчика не может быть получено при повторном вызове этой функции, а также при одновременном вызове параллельно в разных потоках выполнения. Функция **VECTOR** всегда выполняется в контексте соответствующей базы данных, то есть требует использования "внутри" команды **USE**. Вызов функции имеет следующий синтаксис:
```SQL
VECTOR('<sequence_name>')
```
**\<sequence_name\>** - имя объекта последовательности. Имя заключено в одинарные кавычки - это строковой литерал, константа.

**1. Обращение к функции VECTOR вне контекста СУБД генерирует ошибку:**
```SQL
DECLARE @current number
SET @current = SELECT VECTOR('so_my_sequence')
-- Результат выполнения скрипта (ошибка):
-- Parent UseStatement is not found
```

**2. Указание несуществующей последовательности генерирует ошибку:**
```SQL
DECLARE @current number
USE 'mssql://server/database'
   SET @current = SELECT VECTOR('so_my_sequence')
END
-- Результат выполнения скрипта (ошибка):
-- SQL Server: Invalid object name 'so_my_sequence'
-- PostgreSQL: relation "so_my_sequence" does not exist
```

**3. Пример целевого использования функции VECTOR (без ошибок):**
```SQL
DECLARE @next    number
DECLARE @current number

USE 'mssql://server/database'

   -- 1. Вариант использования, @current = 0
   SET @current = SELECT VECTOR('so_my_sequence')

   -- 2. Вариант использования
   SELECT VECTOR('so_my_sequence') INTO @current

   -- Два вызова функции: @current = 2, @next = 0
   SET @next = @current + 1

   -- Фиксируем значения в логе программы
   PRINT 'Значения so_my_sequence:'
   PRINT '- текущее   = ' + @current
   PRINT '- следующее = ' + @next

   -- 3. Целевой вариант использования (запишем значение 2)
   INSERT РегистрСведений.ВходящиеСообщения
   SELECT НомерСообщения = @current
        , ТипСообщения   = 'тест'
        , ТелоСообщения  = 'test'

   -- 4. Целевой вариант использования (запишем значение 3)
   INSERT РегистрСведений.ВходящиеСообщения
   SELECT НомерСообщения = VECTOR('so_my_sequence')
        , ТипСообщения   = 'тест'
        , ТелоСообщения  = 'test'
END

-- Результат выполнения скрипта
[2024-10-07 21:46:30] Значения so_my_sequence:
[2024-10-07 21:46:30] - текущее   = 2
[2024-10-07 21:46:30] - следующее = 3
```

[Наверх](#управление-последовательностью)

#### CREATE SEQUENCE

Команда для создания именованного объекта последовательности базы данных в случае его отсутствия.

```SQL
CREATE SEQUENCE <identifier>
```
**\<identifier\>** - имя объекта последовательности.

> Имя нового объекта последовательности указывается без одинарных кавычек.

**Создание последовательности ```so_my_sequence```**
```SQL
USE 'mssql://server/database'
   CREATE SEQUENCE so_my_sequence
END
```

**На уровне СУБД выполняется следующий код:**
```SQL
-- SQL Server
IF NOT EXISTS(SELECT 1 FROM sys.sequences WHERE name = 'so_my_sequence')
BEGIN
   CREATE SEQUENCE my_sequence AS bigint START WITH 1 INCREMENT BY 1;
END;

-- PostgreSQL
CREATE SEQUENCE IF NOT EXISTS so_my_sequence AS bigint INCREMENT BY 1 START WITH 1 CACHE 1;
```

[Наверх](#управление-последовательностью)

#### DROP SEQUENCE

Команда для удаления именованного объекта последовательности базы данных. В случае его отсутствия генерируется ошибка СУБД.

```SQL
DROP SEQUENCE <identifier>
```
**\<identifier\>** - имя объекта последовательности.

> Имя удаляемого объекта последовательности указывается без одинарных кавычек.

**Удаление последовательности ```so_my_sequence```**
```SQL
USE 'mssql://server/database'
   TRY
      DROP SEQUENCE so_my_sequence
   CATCH
      PRINT ERROR_MESSAGE()
   END -- TRY
END -- USE
```

**На уровне СУБД выполняется следующий код:**
```SQL
-- SQL Server
DROP SEQUENCE so_my_sequence;

-- PostgreSQL
DROP SEQUENCE so_my_sequence;
```

[Наверх](#управление-последовательностью)

#### APPLY SEQUENCE

[Наверх](#управление-последовательностью)

#### REVOKE SEQUENCE

[Наверх](#управление-последовательностью)
