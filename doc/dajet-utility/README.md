## Утилита выполнения скриптов DaJet

[Исходный код утилиты](https://github.com/zhichkin/dajet/tree/main/src/dajet)

### Установка

1. Установить [Microsoft .NET 8 SDK](https://dotnet.microsoft.com/en-us/download/dotnet/8.0)
2. Скачать [дистрибутив утилиты DaJet](https://github.com/zhichkin/dajet/releases)
3. Создать рабочий каталог и распаковать дистрибутив, например: ```C:\dajet-utility```
4. Перейти в каталог установки и выполнить тестовый скрипт ```test.djs```
```SQL
PRINT 'Hello from DaJet!'
```
В случае, если тестовый скрипт отстутствует, создайте его самостоятельно.

Результат выполнения скрипта должен быть следующим:

![Тестовый скрипт Windows](https://github.com/zhichkin/dajet/blob/main/doc/img/dajet-utility-test-windows.png)

Тоже самое для Linux:

![Тестовый скрипт Linux](https://github.com/zhichkin/dajet/blob/main/doc/img/dajet-utility-test-linux.png)

### Описание

Утилита **dajet** может быть использована для хостинга (регулярного) или одноразового выполнения скриптов DaJet. Режим одноразового выполнения предназначен для изучения, тестирования и тому подобных целей. Режим хостинга предполагает промышленное использование технологии и описан ниже.

Исполняемый файл **dajet** находится в корневом каталоге установки, может быть сконфигурирован для запуска как служба **Windows** или демон **Linux** (_поддерживается **systemd**_).

> Файлы скриптов DaJet, а также файл настроек ```config.json```, должны быть в кодировке UTF-8.

### Параметры запуска утилиты DaJet
(из корневого каталога установки)

|**Параметр**|**Windows**|**Linux**|**Описание**|
|---------------|-------|-------|---|
| Нет | dajet | dotnet ./dajet.dll | Хостинг скриптов DaJet с настройками по умолчанию |
| Да | dajet ./script.djs | dotnet ./dajet.dll ./script.djs | Выполнение отдельно взятого скрипта |
| Да | dajet ./config.json | dotnet ./dajet.dll ./config.json | Хостинг скриптов с указанием настроек |

### Значения настроек хостинга по умолчанию

|**Наименование**|**Тип значения**|**Значение**|**Описание**|
|---------------|-------|-------|-------|
| LogSize | Число | 1048576 | Макисмальный размер лога службы в байтах |
| LogFile | Строка | dajet.log | Наименование файла лога службы |
| LogPath | Строка | ./ | Каталог размещения файла лога службы |
| RootPath | Строка | ./stream | Каталог размещения скриптов DaJet Stream |
| Refresh | Число | 600 | Периодичность проверки изменения каталога размещения скриптов в секундах |

### Пример файла настроек config.json

```JSON
{
  "LogSize": 1048576,
  "LogFile": "dajet-2024-08-01.log",
  "LogPath": "./logs",
  "RootPath": "./scripts",
  "Refresh": 60
}
```

Каталог скриптов (_настройка **RootPath**_) может иметь любую структуру. Сервис будет искать скрипты DaJet, как в корневом, так и во всех вложенных в него каталогах. Поиск скриптов DaJet выполняется по шаблону ```*.djs``` (_то есть по расширению файла - **djs**_).

Каждый скрипт DaJet (_конвейер обработки данных_) выполняется сервисом в отдельном потоке операционной системы параллельно и независимо друг от друга. Те скрипты, которые используют команду **CONSUME** выполняются **бесконечно** до полной остановки службы.

Логирование выполняется всеми конвейерами (_потоками выполнения_) в один файл службы, указанный в настройках. Макисмальный размер файла лога означает, что по его достижению файл перезаписывается с самого начала. Логирование действий сервиса имеет больше диагностическое значение для правильной настройки подключений к базам данных и внешним сервисам. Именно поэтому не имеет смысла делать лог большим - достаточно иметь информацию за последние 15-30 минут работы. Практика использования аналогичных сервисов DaJet показала, что такой подход вполне достаточен и удобен.

### Запуск и остановка скриптов "на лету"

Значением опции **Refresh** по умолчанию является 600 секунд. Служба использует этот интервал времени для проверки добавления в корневой каталог скриптов (настройка RootPath) новых файлов с расширением djs. Если новые файлы появились в процессе работы сервиса, то будет выполнена попытка запустить их. Если какой-то из ранее запущенных на выполнение файлов был удалён или его расширение было изменено с djs на любое другое, например, stop, то такой процесс выполнения будет остановлен службой.

Остановка службы DaJet Stream для выполнения этих действий не требуется!

Например, при добавлении нового скрипта amqp-import.djs, в лог службы будет сделана запись вида:

> [STREAM][Assembled in 142 ms] C:\dajet\stream\amqp-import.djs

После удаления или переименования файла amqp-import.djs, например, как amqp-import.stop, будет сделана следующая запись:

> [DISPOSED] C:\dajet\stream\amqp-import.djs
