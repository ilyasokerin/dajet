## Релиз DaJet Stream 3.3.1

[Страница релиза для скачивания](https://github.com/zhichkin/dajet/releases/tag/dajet-3.3.1)

[Ознакомительно видео на YouTube](https://www.youtube.com/watch?v=JuQYzqD7RwI)

> Полностью переделана архитектура процессора скриптов DaJet Stream.
> Код стал более структурированным и понятным для дальнейшего его развития.

**1. Шаблоны URI**

Добавлена возможность шаблонизации URI строк подключения к базам данных. Шаблон для подстановки значений в строке URI выделяется фигурными скобками, между которыми указывается идентификатор переменной скрипта. Функционал добавлен для большего удобства конфигурирования скрипта DaJet Stream.
```SQL
DECLARE @target_server   string = 'zhichkin'
DECLARE @target_database string = 'dajet-exchange'

USE 'mssql://{@target_server}/{@target_database}'

-- Итоговый URI для подключения: mssql://zhichkin/dajet-exchange
```

**2. Иницализация объектных переменных запросом**

Добавлена возможность инициализации объектных переменных запросом к базе данных. Это может быть удобно, например, для получения настроек из базы данных управления обменами, чтобы конфигурировать подключения к другим базам данных в команде переключения контекста **USE**.
```SQL
-- ******************************************************
-- * Чтение настроек из базы данных управления обменами *
-- ******************************************************
USE 'mssql://zhichkin/dajet-exchange'

DECLARE @ms object = SELECT db  = БазаДанных
                          , srv = СерверБазыДанных
                       FROM ПланОбмена.ПланОбменаРИБ
                      WHERE Код = 'РИБ-0001'

-- *********************************************
-- * Подключение к источнику данных SQL Server *
-- *********************************************
USE 'mssql://{@ms.srv}/{@ms.db}'

-- *******************************************************
-- * Пример инициализации объектной переменной итератора *
-- *******************************************************
DECLARE @message object
DECLARE @page    object
DECLARE @iterator array = SELECT RowOffset =    0, PageSize = 1000
                UNION ALL SELECT RowOffset = 1000, PageSize = 1000
                UNION ALL SELECT RowOffset = 2000, PageSize = 1000

FOR EACH @page IN @iterator MAXDOP 3

STREAM Ссылка, Код, Наименование
  INTO @message
  FROM Справочник.Номенклатура
 ORDER BY Код DESC
OFFSET      @page.RowOffset ROWS
 FETCH NEXT @page.PageSize  ROWS ONLY
```

**3. Новая команда STREAM**

Команда **STREAM** - это аналог или синоним команды **SELECT**. Разница заключается в поведении при обработке этой команды **процессором DaJet Stream**. В частности, команда **SELECT** выбирает только первую запись выборки, что эквивалентно **SELECT TOP 1**, а команда **STREAM** обрабатывает все записи выборки, что эквивалентно обычному **SELECT**. Данное дополнение реализовано для того, чтобы процессор скриптов DaJet Stream корректно иницализировал объектную переменную в предложении **INTO** запроса потоковой обработки данных. В остальном поведение обеих команд идентично.

### DaJet Stream: адаптер RabbitMQ

**1. Новая команда PRODUCE**

Новая команда **PRODUCE** предназначена для отправки сообщений во внешние системы, например, брокеры сообщений. Самый простой способ отправить сообщение в RabbitMQ - это выполнить ниже следующий скрипт. При этом нужно сказать, что URI сервера RabbitMQ  в команде **PRODUCE** может быть шаблоном, как это было описано ранее для команды **USE** для подключения к базам данных.
```SQL
-- ****************************************************************************
-- * Приёмник сообщений RabbitMQ, виртуальный хост dajet, топик test-exchange *
-- ****************************************************************************

PRODUCE 'amqp://guest:guest@localhost:5672/dajet'
   WITH Exchange   = 'test-exchange' -- Наименование топика
      , RoutingKey = 'AAA'           -- Ключ маршрутизации
      , CarbonCopy = 'BBB,CCC,DDD'   -- Дополнительные ключи маршрутизации (csv)
      , MessageId  = 'msg-no-1234'   -- Идентификатор сообщения
 SELECT AppId = 'test sender'            -- Отправитель
      , Type  = 'Тестовый тип сообщения' -- Тип сообщения
      , Body  = 'Тестовое сообщение'     -- Тело сообщения
      , ContentType = 'text/plain'
```

**Доступные свойства сообщения RabbitMQ**
|**Наименование**|**Тип данных**|**Описание**|
|---------------|-------|-------|
| AppId | string | Наименование отправителя |
| Exchange | string | Наименование топика |
| RoutingKey | string | Ключ маршрутизации, если свойство Exchange заполнено. В противном случае - наименование очереди для прямой отправки в очередь без маршрутизации. |
| Mandatory | number | Признак обязательности наличия очереди назначения. Подробнее лучше почитать в документации RabbitMQ. По умолчанию DaJet Stream не использует этот флаг. |
| MessageId | string | Идентификатор сообщения |
| BlindCopy | string (csv) | Дополнительные ключи маршрутизации. Значения ключей не доставляются получателю. |
| CarbonCopy | string (csv) | Дополнительные ключи маршрутизации. Значения ключей доставляются получателю. Использовать не рекомендуется. |
| Type | string | Тип сообщения |
| Body | string | Тело сообщения. DaJet Stream ориентируется на текстовые сообщения в формате UTF-8. |
| ContentType | string | Тип содержимого тела сообщения. Значение по умолчанию: **application/json** |
| ContentEncoding | string | Формат (кодировка) тела сообщения. Значение по умолчанию: **UTF-8** |
| DeliveryMode | number | Вид доставки: 1 - in-memory, 2 - persistent. Значение по умолчанию: **2** (сохранение на диск) |
| Priority | number | Приоритет доставки сообщения от 0 до 9. Значение по умолчанию: **0** |
| ReplyTo | string | Адресат для обратной связи |
| CorrelationId | string | Идентификатор корреляции сообщений между собой, определяемый логикой приложения. |
| Expiration | string | Спецификация устаревания сообщения. Подробнее лучше почитать в документации RabbitMQ. |

**2. Пример отправки сообщений из регистра сведений в RabbitMQ**

В ниже приведённом примере используется команда деструктивного чтения [**CONSUME**](https://zhichkin.github.io/async-data/index.html) (сообщения удаляются после отправки) со строгим соблюдением гарантии доставки **at-least-once-in-order** (как минимум один раз в порядке выборки). В случае возникновения ошибки транзакция деструктивного чтения откатывается и все сообщения текущего пакета (TOP 1000) возвращаются обратно в таблицу-очередь базы данных.
```SQL
DECLARE @message object
DECLARE @empty_uuid uuid = "00000000-0000-0000-0000-000000000000"

-- ***********************************************************************
-- * Источник сообщений SQL Server - регистр сведений "ИсходящаяОчередь" *
-- ***********************************************************************
USE "mssql://zhichkin/dajet-exchange"

DECLARE @Отправитель string = SELECT Код
                                FROM ПланОбмена.ПланОбменаРИБ
                               WHERE Предопределённый <> @empty_uuid

CONSUME TOP 1000
        НомерСообщения, ТипСообщения, ТелоСообщения
   INTO @message
   FROM РегистрСведений.ИсходящиеСообщения
  ORDER BY НомерСообщения ASC

-- ****************************************************************************
-- * Приёмник сообщений RabbitMQ, виртуальный хост dajet, топик test-exchange *
-- ****************************************************************************

PRODUCE 'amqp://guest:guest@localhost:5672/dajet'
   WITH AppId = @Отправитель
 SELECT Type  = @message.ТипСообщения
      , Body  = @message.ТелоСообщения
      , Exchange  = 'test-exchange'
      , MessageId = @message.НомерСообщения
```

**3. Дополнение команды CONSUME для RabbitMQ**

Новый функционал команда **CONSUME** предназначен для получения сообщений из внешних систем, например, брокеров сообщений. Ниже следующий скрипт демонстрирует получение сообщений из очереди RabbitMQ в регистр сведений базы данных. При этом выполняются все гарантии доставки сообщений **at-least-once-in-order** (как минимум один раз по порядку). Сообщения не теряются.
```SQL
DECLARE @source  string = 'guest:guest@localhost:5672/dajet'
DECLARE @target  string = 'postgres:postgres@127.0.0.1:5432/dajet-demo-pg'
DECLARE @message object

-- ***************************************************************************
-- * Источник сообщений RabbitMQ, виртуальный хост dajet, очередь test-queue *
-- ***************************************************************************

CONSUME 'amqp://{@source}'
   WITH QueueName = 'test-queue', Heartbeat = 5
   INTO @message

-- ************************************************************************
-- * Приёмник сообщений Postgre SQL - регистр сведений "ВходящиеСообщения" *
-- ************************************************************************
USE 'pgsql://{@target}'

INSERT РегистрСведений.ВходящиеСообщения
SELECT НомерСообщения = VECTOR('so_incoming_queue')
     , ОтметкаВремени = NOW()
     , Отправитель    = @message.AppId
     , ТипСообщения   = @message.Type
     , ТелоСообщения  = @message.Body
     , Получатели     = @message.ContentType
```
**Доступные свойства настройки получения сообщений RabbitMQ**
|**Наименование**|**Тип данных**|**Описание**|
|---------------|-------|-------|
| QueueName | string | Наименование очереди для получения сообщений |
| Heartbeat | number | Период проверки в секундах наличия подключения к RabbitMQ. В случае его потери - автоматическое восстановление. Кроме этого данное значение используется для периодического вывода количества обработанных (успешно полученных) за это время сообщений в консоль или журнал DaJet Stream. |
| PrefetchSize | number | Размер клиентского буфера в байтах. Значение по умолчанию: **неограниченно**. Подробнее лучше почитать в документации RabbitMQ. |
| PrefetchCount | number | Количество сообщений, которые могут быть отправлены сервером без подтверждения. Значение по умолчанию: **1**. Данное значение выбрано DaJet Stream для обеспечения гарантий доставки **at-least-once-in-order**. Подробнее лучше почитать в документации RabbitMQ. |

**Доступные свойства сообщения при получении из RabbitMQ**
|**Наименование**|**Тип данных**|**Описание**|
|---------------|-------|-------|
| AppId | string | Наименование отправителя |
| MessageId | string | Идентификатор сообщения |
| Type | string | Тип сообщения |
| Body | string | Тело сообщения. DaJet Stream ориентируется на текстовые сообщения в формате UTF-8. |
| ContentType | string | Тип содержимого тела сообщения. Значение по умолчанию: **application/json** |
| ContentEncoding | string | Формат (кодировка) тела сообщения. Значение по умолчанию: **UTF-8** |
| ReplyTo | string | Адресат для обратной связи |
| CorrelationId | string | Идентификатор корреляции сообщений между собой, определяемый логикой приложения. |

**4. DaJet Stream: RabbitMQ Shovel**

Ниже приводится пример скрипта получения сообщений из одной очереди RabbitMQ и их отправки в другую очередь или топик RabbitMQ средствами DaJet Stream. По сути своей это аналог плагина **Shovel** для RabbitMQ. При этом очереди могут находиться на разных серверах RabbitMQ - нужно только поменять соответствующие URI подключений в скрипте DaJet Stream.
```SQL
DECLARE @source  string = 'guest:guest@localhost:5672/dajet'
DECLARE @target  string = 'guest:guest@localhost:5672/dajet'
DECLARE @message object

-- ***************************************************************************
-- * Источник сообщений RabbitMQ, виртуальный хост dajet, очередь test-queue *
-- ***************************************************************************

CONSUME 'amqp://{@source}'
   WITH QueueName = 'test-queue', Heartbeat = 5
   INTO @message

-- ****************************************************************************
-- * Приёмник сообщений RabbitMQ, виртуальный хост dajet, очередь test-shovel *
-- ****************************************************************************
PRODUCE 'amqp://{@target}'
 SELECT AppId = @message.AppId
      , Type  = @message.Type
      , Body  = @message.Body
      , RoutingKey = 'test-shovel'
      , MessageId  = @message.MessageId
```

**Примечание**
> Все команды **CONSUME**, как для баз данных, так и для брокеров сообщений, подразумевают "бесконечное" потребление потока данных с автоматическим восстановлением подключений к своим источникам в случае их разрыва. Остановить работу утилиты **dajet** в таком случае можно при помощи нажатия комбинации клавиш **CTRL+C** или принудительно прервав процесс выполнения программы административными или иными средствами. Потери сообщений или каких-либо данных при этом не произойдёт - эти гарантии дают соответствующие средства обсепечения ACID транзакций баз данных, в том числе RabbitMQ (Mnesia). Процессор скриптов DaJet Stream выполняет для этого все требования, рекомендуемые производителями согласно их официальной документации.

**Выполнение скрипта DaJet Stream в среде Windows**
```SQL
-- из корневого каталога установки
dajet stream --file ./stream/script.sql
```

**Выполнение скрипта DaJet Stream в среде Linux**
```SQL
-- из корневого каталога установки
dotnet ./dajet.dll stream --file ./stream/script.sql
```
