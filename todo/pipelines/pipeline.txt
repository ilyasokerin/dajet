https://medium.com/@bonnotguillaume/software-architecture-the-pipeline-design-pattern-from-zero-to-hero-b5c43d8a4e60

SELECT
  МоментВремени    AS МоментВремени,
  Идентификатор    AS Идентификатор,
  Заголовки        AS Заголовки,
  Отправитель      AS Отправитель,
  Получатели       AS Получатели,
  ТипСообщения     AS ТипСообщения,
  ТелоСообщения    AS ТелоСообщения,
  ДатаВремя        AS ДатаВремя,
  ТипОперации      AS ТипОперации,
  ОписаниеОшибки   AS ОписаниеОшибки,
  КоличествоОшибок AS КоличествоОшибок
FROM
  РегистрСведений.ИсходящаяОчередь12;

SELECT
  МоментВремени    AS МоментВремени,
  Идентификатор    AS Идентификатор,
  Заголовки        AS Заголовки,
  Отправитель      AS Отправитель,
  ТипСообщения     AS ТипСообщения,
  ТелоСообщения    AS ТелоСообщения,
  ДатаВремя        AS ДатаВремя,
  ТипОперации      AS ТипОперации,
  ОписаниеОшибки   AS ОписаниеОшибки,
  КоличествоОшибок AS КоличествоОшибок
FROM
  РегистрСведений.ВходящаяОчередь12;

**********************************************************

DECLARE @MessageCount number = 1000;

WITH cte AS
(SELECT TOP (@MessageCount)
  МоментВремени AS МоментВремени,
  Идентификатор AS Идентификатор,
  Заголовки     AS Заголовки,
  Отправитель   AS Отправитель,
  Получатели    AS Получатели,
  ТипСообщения  AS ТипСообщения,
  ТелоСообщения AS ТелоСообщения,
  ДатаВремя     AS ДатаВремя,
  ТипОперации   AS ТипОперации
FROM
  РегистрСведений.ИсходящаяОчередь12 WITH (ROWLOCK, READPAST)
ORDER BY
  МоментВремени ASC, Идентификатор ASC
)
DELETE cte OUTPUT
  deleted.МоментВремени, deleted.Идентификатор, deleted.Заголовки,
  deleted.Отправитель,   deleted.Получатели,
  deleted.ТипСообщения,  deleted.ТелоСообщения,
  deleted.ДатаВремя,     deleted.ТипОперации
;

INSERT {TABLE_NAME}
({МоментВремени}, {Идентификатор}, {Заголовки}, {Отправитель}, {ТипСообщения}, {ТелоСообщения},
{ДатаВремя}, {ОписаниеОшибки}, {КоличествоОшибок}, {ТипОперации})
SELECT NEXT VALUE FOR DaJetIncomingQueueSequence,
@Идентификатор, @Заголовки, @Отправитель, @ТипСообщения, @ТелоСообщения,
@ДатаВремя, @ОписаниеОшибки, @КоличествоОшибок, @ТипОперации;

********************************************************************

"WITH cte AS (SELECT {МоментВремени}, {Идентификатор} " +
"FROM {TABLE_NAME} ORDER BY {МоментВремени} ASC, {Идентификатор} ASC LIMIT @MessageCount), " +
"del AS (DELETE FROM {TABLE_NAME} t USING cte " +
"WHERE t.{МоментВремени} = cte.{МоментВремени} AND t.{Идентификатор} = cte.{Идентификатор} " +
"RETURNING t.{МоментВремени}, t.{Идентификатор}, " +
"t.{Заголовки}, t.{Отправитель}, t.{Получатели}, " +
"t.{ТипСообщения}, t.{ТелоСообщения}, " +
"t.{ДатаВремя}, t.{ТипОперации}, t.{ОписаниеОшибки}, t.{КоличествоОшибок}) " +
"SELECT del.{МоментВремени} AS \"МоментВремени\", del.{Идентификатор} AS \"Идентификатор\", " +
"CAST(del.{Заголовки} AS text) AS \"Заголовки\", " +
"CAST(del.{Отправитель} AS varchar) AS \"Отправитель\", CAST(del.{Получатели} AS text) AS \"Получатели\", " +
"CAST(del.{ТипСообщения} AS varchar) AS \"ТипСообщения\", CAST(del.{ТелоСообщения} AS text) AS \"ТелоСообщения\", " +
"del.{ДатаВремя} AS \"ДатаВремя\", CAST(del.{ТипОперации} AS varchar) AS \"ТипОперации\", " +
"CAST(del.{ОписаниеОшибки} AS varchar) AS \"ОписаниеОшибки\", del.{КоличествоОшибок} AS \"КоличествоОшибок\" " +
"FROM del ORDER BY del.{МоментВремени} ASC;";

"INSERT INTO {TABLE_NAME} " +
"({МоментВремени}, {Идентификатор}, {Заголовки}, {Отправитель}, {ТипСообщения}, {ТелоСообщения}, " +
"{ДатаВремя}, {ОписаниеОшибки}, {КоличествоОшибок}, {ТипОперации}) " +
"SELECT CAST(nextval('DaJetIncomingQueueSequence') AS numeric(19,0)), " +
"@Идентификатор, CAST(@Заголовки AS mvarchar), CAST(@Отправитель AS mvarchar), CAST(@ТипСообщения AS mvarchar), " +
"CAST(@ТелоСообщения AS mvarchar), @ДатаВремя, CAST(@ОписаниеОшибки AS mvarchar), @КоличествоОшибок, CAST(@ТипОперации AS mvarchar);";